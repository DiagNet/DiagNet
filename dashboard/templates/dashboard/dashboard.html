<!-- html -->
{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard - DiagNet{% endblock %}
{% block content %}
    <div class="mb-4">
        <h1 class="fw-bold">DiagNet Dashboard</h1>
        <p class="text-muted">Network test overview – {{ range_label }}.</p>
    </div>
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card mb-4" style="height:350px;">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="fw-semibold mb-0">Test Groups</h5>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button"
                                    id="groupsPrev"
                                    class="btn btn-sm btn-outline-secondary py-0 px-2">‹</button>
                            <span id="groupsPageInfo" class="small text-muted"></span>
                            <button type="button"
                                    id="groupsNext"
                                    class="btn btn-sm btn-outline-secondary py-0 px-2">›</button>
                        </div>
                    </div>
                    <form method="get">
                        <select name="range"
                                class="form-select form-select-sm"
                                onchange="this.form.submit()">
                            <option value="24h" {% if range_code == '24h' %}selected{% endif %}>24 hours</option>
                            <option value="7d" {% if range_code == '7d' %}selected{% endif %}>7 days</option>
                            <option value="30d" {% if range_code == '30d' %}selected{% endif %}>30 days</option>
                            <option value="all" {% if range_code == 'all' %}selected{% endif %}>All</option>
                        </select>
                    </form>
                    <div class="mt-2" style="flex:1;">
                        <canvas id="testgroupChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="card" style="height:350px;">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="fw-semibold mb-0">TestCases</h5>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button"
                                    id="tcPrev"
                                    class="btn btn-sm btn-outline-secondary py-0 px-2">‹</button>
                            <span id="tcPageInfo" class="small text-muted"></span>
                            <button type="button"
                                    id="tcNext"
                                    class="btn btn-sm btn-outline-secondary py-0 px-2">›</button>
                        </div>
                    </div>
                    <form method="get">
                        <input type="hidden" name="range" value="{{ range_code }}">
                        <select name="tcgroup"
                                class="form-select form-select-sm"
                                onchange="this.form.submit()">
                            {% for g in groups %}
                                <option value="{{ g.name }}"
                                        {% if selected_group and selected_group.name == g.name %}selected{% endif %}>
                                    {{ g.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                    <div class="mt-2" style="flex:1;">
                        <canvas id="testcaseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8">{% include "dashboard/partials/dashboard_results.html" %}</div>
    </div>
    {{ group_labels|json_script:"group-labels" }}
    {{ group_passes|json_script:"group-passes" }}
    {{ group_fails|json_script:"group-fails" }}
    {{ testcase_labels|json_script:"tc-labels" }}
    {{ testcase_passes|json_script:"tc-passes" }}
    {{ testcase_fails|json_script:"tc-fails" }}
{% endblock %}
{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    (function () {
        const style = getComputedStyle(document.documentElement);

        const passColor = style.getPropertyValue("--bs-success");
        const failColor = style.getPropertyValue("--bs-danger");
        const textMuted = style.getPropertyValue("--bs-secondary-color");
        const gridColor = style.getPropertyValue("--bs-border-color");

        function createPagedBarChart(canvasId, labels, passes, fails, pageSize, controls) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !labels || labels.length === 0) return null;

            let page = 0;
            const total = labels.length;
            const pages = Math.max(1, Math.ceil(total / pageSize));

            function getSlice() {
                const start = page * pageSize;
                return {
                    labels: labels.slice(start, start + pageSize),
                    passes: passes.slice(start, start + pageSize),
                    fails: fails.slice(start, start + pageSize),
                };
            }

            const s = getSlice();

            const chart = new Chart(canvas, {
                type: "bar",
                data: {
                    labels: s.labels,
                    datasets: [
                        { label: "Pass", data: s.passes, backgroundColor: passColor, stack: "stack" },
                        { label: "Fail", data: s.fails,  backgroundColor: failColor, stack: "stack" }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: textMuted } } },
                    scales: {
                        x: { stacked: true, ticks: { color: textMuted }, grid: { display: false } },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: { stepSize: 1, precision: 0, color: textMuted },
                            grid: { color: gridColor }
                        }
                    }
                }
            });

            function updatePaging() {
                const { prev, next, info } = controls;
                if (pages <= 1) {
                    prev.style.visibility = "hidden";
                    next.style.visibility = "hidden";
                    info.textContent = "";
                    return;
                }
                prev.style.visibility = "visible";
                next.style.visibility = "visible";
                info.textContent = `Page ${page + 1} / ${pages}`;
            }

            function go(newPage) {
                if (newPage < 0 || newPage >= pages) return;
                page = newPage;
                const s = getSlice();
                chart.data.labels = s.labels;
                chart.data.datasets[0].data = s.passes;
                chart.data.datasets[1].data = s.fails;
                chart.update();
                updatePaging();
            }

            controls.prev.addEventListener("click", () => go(page - 1));
            controls.next.addEventListener("click", () => go(page + 1));

            updatePaging();
            return chart;
        }

        const glElem = document.getElementById("group-labels");
        const gpElem = document.getElementById("group-passes");
        const gfElem = document.getElementById("group-fails");

        if (glElem && gpElem && gfElem) {
            createPagedBarChart(
                "testgroupChart",
                JSON.parse(glElem.textContent),
                JSON.parse(gpElem.textContent),
                JSON.parse(gfElem.textContent),
                5,
                {
                    prev: document.getElementById("groupsPrev"),
                    next: document.getElementById("groupsNext"),
                    info: document.getElementById("groupsPageInfo")
                }
            );
        }

        const tlElem = document.getElementById("tc-labels");
        const tpElem = document.getElementById("tc-passes");
        const tfElem = document.getElementById("tc-fails");

        if (tlElem && tpElem && tfElem) {
            createPagedBarChart(
                "testcaseChart",
                JSON.parse(tlElem.textContent),
                JSON.parse(tpElem.textContent),
                JSON.parse(tfElem.textContent),
                6,
                {
                    prev: document.getElementById("tcPrev"),
                    next: document.getElementById("tcNext"),
                    info: document.getElementById("tcPageInfo")
                }
            );
        }

    })();
    </script>
{% endblock %}
