<!-- html -->
{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard - DiagNet{% endblock %}
{% block content %}
    <div class="mb-4">
        <h1 class="fw-bold">DiagNet Dashboard</h1>
        <p class="text-muted placeholder-glow" id="range-label">
            <span class="placeholder col-4"></span>
        </p>
    </div>
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card mb-4" style="height:350px;">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="fs-5 fw-semibold mb-0">Test Groups</h2>
                    </div>
                    <form>
                        <select name="range" id="range-select" class="form-select form-select-sm">
                            <option value="24h">24 hours</option>
                            <option value="7d">7 days</option>
                            <option value="30d">30 days</option>
                            <option value="all">All</option>
                        </select>
                    </form>
                    <div class="mt-2" style="flex:1;">
                        <canvas id="testgroupChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="card" style="height:350px;">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="fs-5 fw-semibold mb-0">TestCases</h2>
                    </div>
                    <form>
                        <select name="tcgroup" id="tcgroup-select" class="form-select form-select-sm"></select>
                    </form>
                    <div class="mt-2" style="flex:1;">
                        <canvas id="testcaseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8">{% include "dashboard/partials/dashboard_results.html" %}</div>
    </div>
{% endblock %}
{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    (function () {
        const charts = [];
        const style = getComputedStyle(document.documentElement);

        const getChartColors = () => ({
            passColor: style.getPropertyValue("--bs-success"),
            failColor: style.getPropertyValue("--bs-danger"),
            textMuted: style.getPropertyValue("--bs-secondary-color"),
            gridColor: style.getPropertyValue("--bs-border-color"),
        });

        function updateCharts() {
            const colors = getChartColors();
            charts.forEach(chart => {
                const legend = chart.options.plugins.legend;
                if (legend) legend.labels.color = colors.textMuted;

                const ticksX = chart.options.scales.x.ticks;
                if (ticksX) ticksX.color = colors.textMuted;

                const ticksY = chart.options.scales.y.ticks;
                if (ticksY) ticksY.color = colors.textMuted;

                const gridY = chart.options.scales.y.grid;
                if (gridY) gridY.color = colors.gridColor;
                chart.update();
            });
        }

        const themeObserver = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                if (mutation.type === "attributes" && mutation.attributeName === "data-bs-theme") {
                    updateCharts();
                }
            }
        });
        themeObserver.observe(document.documentElement, { attributes: true });


        function createBarChart(canvasId, labels, passes, fails) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;

            const colors = getChartColors();

            const chart = new Chart(canvas, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        { label: "Pass", data: passes, backgroundColor: colors.passColor, stack: "stack" },
                        { label: "Fail", data: fails,  backgroundColor: colors.failColor, stack: "stack" }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: colors.textMuted } } },
                    scales: {
                        x: { stacked: true, ticks: { color: colors.textMuted }, grid: { display: false } },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: { stepSize: 1, precision: 0, color: colors.textMuted },
                            grid: { color: colors.gridColor }
                        }
                    }
                }
            });
            charts.push(chart);
            return chart;
        }

        const groupChart = createBarChart("testgroupChart", [], [], []);
        const testcaseChart = createBarChart("testcaseChart", [], [], []);

        const rangeSelect = document.getElementById("range-select");
        const tcGroupSelect = document.getElementById("tcgroup-select");
        const rangeLabel = document.getElementById("range-label");

        async function fetchData() {
            const range = rangeSelect.value;
            const tcgroup = tcGroupSelect.value;
            const url = `/data/?range=${range}&tcgroup=${tcgroup}`;
            const response = await fetch(url);
            const data = await response.json();

            rangeLabel.textContent = `Network test overview – ${data.range_label}.`;

            groupChart.data.labels = data.group_labels;
            groupChart.data.datasets[0].data = data.group_passes;
            groupChart.data.datasets[1].data = data.group_fails;
            groupChart.update();

            testcaseChart.data.labels = data.testcase_labels;
            testcaseChart.data.datasets[0].data = data.testcase_passes;
            testcaseChart.data.datasets[1].data = data.testcase_fails;
            testcaseChart.update();

            document.getElementById("total-runs").innerHTML = data.total;
            document.getElementById("passed-runs").innerHTML = data.passes;
            document.getElementById("failed-runs").innerHTML = data.fails;

            const recentRunsTable = document.getElementById("recent-runs-table");
            recentRunsTable.innerHTML = "";
            if (data.recent.length > 0) {
                data.recent.forEach(r => {
                    const row = document.createElement("tr");
                    row.className = r.result ? "table-success" : "table-danger";
                    row.dataset.testcase = r.test_case.toLowerCase();

                    const startedAt = new Date(r.started_at);
                    const formattedStartedAt = startedAt.getFullYear() + '-' +
                        ('0' + (startedAt.getMonth() + 1)).slice(-2) + '-' +
                        ('0' + startedAt.getDate()).slice(-2) + ' ' +
                        ('0' + startedAt.getHours()).slice(-2) + ':' +
                        ('0' + startedAt.getMinutes()).slice(-2);

                    let logPreview = '<span class="text-muted">—</span>';
                    if (r.log && typeof r.log === 'object' && r.log.tests) {
                        for (const testName in r.log.tests) {
                            const test = r.log.tests[testName];
                            if (test.status === 'FAIL') {
                                logPreview = `<pre style="white-space:pre-wrap;margin:0;">${test.message}</pre>`;
                                break;
                            }
                        }
                    }

                    row.innerHTML = `
                        <td class="text-nowrap">${formattedStartedAt}</td>
                        <td>${r.test_case}</td>
                        <td>
                            ${r.result
                                ? '<span class="fw-semibold text-success">PASS</span>'
                                : '<span class="fw-semibold text-danger">FAIL</span>'
                            }
                        </td>
                        <td class="small">${logPreview}</td>
                    `;
                    recentRunsTable.appendChild(row);
                });
            } else {
                recentRunsTable.innerHTML = '<tr><td colspan="4" class="text-muted">No test results found for this period.</td></tr>';
            }

            // Update the test case group selector
            const currentTcGroup = tcGroupSelect.value;
            tcGroupSelect.innerHTML = "";
            data.groups.forEach(group => {
                const option = document.createElement("option");
                option.value = group;
                option.textContent = group;
                if (group === data.selected_group) {
                    option.selected = true;
                }
                tcGroupSelect.appendChild(option);
            });
        }

        rangeSelect.addEventListener("change", fetchData);
        tcGroupSelect.addEventListener("change", fetchData);

        // Initial data load
        fetchData();

    })();
    </script>
{% endblock %}
