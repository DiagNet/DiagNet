{% extends "base.html" %}

{% block title %}Users - DiagNet{% endblock %}

{% block content %}
<div id="user-urls"
	data-detail-url="{% url 'user-detail' 0 %}"
	data-edit-url="{% url 'user-update' 0 %}"
	data-password-url="{% url 'user-password' 0 %}"
	data-create-url="{% url 'user-create' %}">
</div>

<h1>Users</h1>

<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#userCreateModal">
	Add User
</button>

<!-- User Create Modal -->
<div class="modal fade" id="userCreateModal" tabindex="-1" aria-labelledby="userCreateModalLabel">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="userCreateModalLabel">Create A User</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" hx-get="{% url 'user-create' %}" hx-trigger="load" hx-target="this" hx-swap="innerHTML">
				<div class="text-center">
					<div class="spinner-border" role="status">
						<span class="visually-hidden">Loading form...</span>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- User Detail Modal -->
<div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="userDetailModalLabel">User Details</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" id="userDetailModalBody">
				<div class="text-center">
					<div class="spinner-border" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- User Edit Modal -->
<div class="modal fade" id="userEditModal" tabindex="-1" aria-labelledby="userEditModalLabel">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="userEditModalLabel">Edit User</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" id="userEditModalBody">
				<div class="text-center">
					<div class="spinner-border" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- User Password Modal -->
<div class="modal fade" id="userPasswordModal" tabindex="-1" aria-labelledby="userPasswordModalLabel">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="userPasswordModalLabel">Change Password</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" id="userPasswordModalBody">
				<div class="text-center">
					<div class="spinner-border" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div hx-get="{% url 'user-list' %}" hx-trigger="refresh from:body" hx-swap="innerHTML" hx-select="#user-table-content" id="user-table">
	<div id="user-table-content">
		<div class="table-responsive">
			<table class="table table-striped">
				<thead>
					<tr>
						<th>Username</th>
						<th>Email</th>
						<th>Status</th>
						<th>Groups</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					{% if users %}
					{% for account in users %}
					<tr id="user-{{ account.pk }}">
						<td class="align-middle">
							<button class="btn btn-link detail-user-btn" data-user-id="{{ account.pk }}">{{ account.username }}</button>
							{% if account == request.user %}<span class="badge bg-info">You</span>{% endif %}
						</td>
						<td class="align-middle">{{ account.email|default:"-" }}</td>
						<td class="align-middle">
							{% if account.is_superuser %}
							<span class="badge bg-danger">Superuser</span>
							{% elif account.is_staff %}
							<span class="badge bg-warning text-dark">Staff</span>
							{% elif account.is_active %}
							<span class="badge bg-success">Active</span>
							{% else %}
							<span class="badge bg-secondary">Inactive</span>
							{% endif %}
						</td>
						<td class="align-middle">
							{% for group in account.groups.all %}
							<span class="badge bg-primary">{{ group.name }}</span>
							{% empty %}
							-
							{% endfor %}
						</td>
						<td class="align-middle">
							<button title="Edit user" class="btn btn-sm btn-primary edit-user-btn" data-user-id="{{ account.pk }}">
								<i class="bi bi-pencil"></i>
							</button>
							<button title="Change password" class="btn btn-sm btn-warning password-user-btn" data-user-id="{{ account.pk }}">
								<i class="bi bi-key"></i>
							</button>
							{% if account != request.user and not account.is_superuser %}
							<button title="Delete user" class="btn btn-sm btn-danger"
								hx-delete="{% url 'user-delete' account.pk %}"
								hx-headers='{"X-CSRFToken": "{{ csrf_token|escapejs }}"}'
								hx-confirm="Are you sure you want to delete the user '{{ account.username }}'?">
								<i class="bi bi-trash"></i>
							</button>
							{% endif %}
						</td>
					</tr>
					{% endfor %}
					{% else %}
					<tr>
						<td colspan="5">No users yet.</td>
					</tr>
					{% endif %}
				</tbody>
			</table>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
{% load static %}
<script src="{% static 'accounts/js/user_management.js' %}"></script>
{% endblock %}
