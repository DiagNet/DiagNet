{% extends "base.html" %}

{% block title %} Test Cases {% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Test Cases</h1>
    {% if page_obj.object_list %}
    {% regroup page_obj.object_list by devices.all.0.device.name as grouped_testcases %}
    {% for group in grouped_testcases %}
    <h4 class="mt-4"> {{ group.grouper|default:"Unassigned" }}</h4>
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">Label</th>
                    <th scope="col">Parameters</th>
                    <th scope="col">Devices</th>
                    <th scope="col" class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for tc in group.list %}
                <tr id="testcase-row-{{ tc.id }}">
                    <!-- Label -->
                    <td><strong>{{ tc.label }}</strong></td>

                    <!-- Parameters -->
                    <td>
                        {% if tc.num_params %}
                        <button class="btn btn-link p-0 text-decoration-none" data-bs-toggle="collapse"
                            data-bs-target="#params-{{ tc.id }}" aria-expanded="false"
                            aria-controls="params-{{ tc.id }}">
                            {{ tc.num_params }} param{{ tc.num_params|pluralize }}
                        </button>
                        <div id="params-{{ tc.id }}" class="collapse">
                            <div class="mt-1 small">
                                {% for p in tc.parameters.all %}
                                <span class="badge bg-secondary me-1">
                                    {{ p.name }}{% if p.value %}: {{ p.value }}{% endif %}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% else %}
                        0 params
                        {% endif %}
                    </td>

                    <!-- Devices -->
                    <td>
                        {% if tc.num_devices %}
                        {% for td in tc.devices.all %}
                        <span class="badge bg-light border me-1">
                            {{ td.device.name }}{% if td.name %} ({{ td.name }}){% endif %}
                        </span>
                        {% endfor %}
                        {% else %}
                        None
                        {% endif %}
                    </td>

                    <!-- Actions -->

                    <td class="text-end">
                        <!-- Run -->
                            <form class="d-inline" hx-post="{% url 'tests-run' tc.id %}" hx-target="#result-{{ tc.id }}"
                                hx-swap="innerHTML">
                                buttons)
                                {% csrf_token %}
                                <button class="btn btn-sm btn-primary me-1" hx-indicator="#spinner-{{ tc.id }}">
                                    Run
                                </button>
                                <span id="spinner-{{ tc.id }}" class="htmx-indicator ms-1 small">...loading
                                </span>
                            </form>
                            <!-- Delete -->
                                <button class="btn btn-sm btn-danger" hx-delete="{% url 'testcase_delete' tc.id %}"
                                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                    hx-target="#testcase-row-{{ tc.id }}" hx-swap="outerHTML"
                                    hx-confirm="Do you really want to delete this test case?"
                                    hx-on::after-request="location.reload()">
                                    üóëÔ∏è
                                    buttons)
                                </button>
                    </td>
                </tr>
                <!-- Result row -->
                <tr>
                    <td colspan="4">
                        <div id="result-{{ tc.id }}" class="mt-2 small"></div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}

    <!-- Pagination -->
    <div class="mt-4 d-flex justify-content-center">
        <ul class="pagination">
            {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">¬ª</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">¬´</span></li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">Page {{ page_obj.number }} / {{page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">¬ª</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">¬ª</span></li>
            {% endif %}
        </ul>
    </div>

    {% else %}
    <div class="alert alert-info">No test cases created yet.</div>
    {% endif %}

</div>
{% endblock %}
